<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>THE LINKS. KTV BATAM - Remote Fixed</title>
<style>
  *{box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{margin:0;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;overflow:hidden;}
  header{padding:10px 20px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:space-between;}
  #searchBar{display:flex;gap:10px;align-items:center;}
  input{padding:10px;border:none;border-radius:5px;width:300px;}
  button{background:#1db954;border:none;color:#fff;padding:10px 15px;border-radius:5px;cursor:pointer;transition:0.2s;}
  button:hover{background:#1ed760;}
  #container{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 130px);}
  #searchResults,#playlist{overflow-y:auto;padding:15px;background:rgba(255,255,255,0.05);}
  .song{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.05);margin-bottom:8px;padding:8px;border-radius:6px;cursor:pointer;transition:0.2s;}
  .song:hover{background:rgba(255,255,255,0.15);}
  img.thumb{width:80px;border-radius:4px;}
  .title{font-weight:bold;font-size:14px;}
  .channel{font-size:12px;color:#ccc;}
  #controls{display:flex;gap:10px;justify-content:center;padding:10px;background:rgba(0,0,0,0.3);}
  #virtualKeyboard{display:none;grid-template-columns:repeat(10,1fr);gap:5px;padding:10px;background:rgba(0,0,0,0.3);position:absolute;bottom:10px;left:50%;transform:translateX(-50%);border-radius:10px;}
  #virtualKeyboard button{background:#333;border:1px solid #444;color:#FFD700;font-weight:bold;}
  #navButtons{display:flex;gap:5px;}
  #qr-container {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background:#111;
    padding:10px;
    border-radius:10px;
    text-align:center;
    z-index:9999;
  }
  #qr-container p{color:#fff;font-size:12px;margin:6px 0 0;}
</style>
</head>
<body>

<header>
  <div><strong>THE LINKS. KTV BATAM</strong></div>
  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Cari lagu..." />
    <button id="searchBtn">Cari</button>
    <div id="navButtons">
      <button id="upBtn">▲</button>
      <button id="downBtn">▼</button>
    </div>
    <button id="openPlayerBtn">Buka Layar 2</button>
  </div>
</header>

<div id="container">
  <div id="searchResults"></div>
  <div id="playlist"></div>
</div>

<div id="controls">
  <button id="playBtn">PLAY</button>
  <button id="pauseBtn">PAUSE</button>
  <button id="nextBtn">NEXT</button>
  <button id="moveUpBtn">UP</button>
  <button id="moveDownBtn">DOWN</button>
  <button id="clearBtn">CLEAR</button>
</div>

<div id="virtualKeyboard"></div>

<div id="qr-container" style="display:none;">
  <div id="qrcode"></div>
  <p>Scan untuk kontrol dari HP</p>
</div>

<!-- Firebase & QRCode -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const isRemote = (new URLSearchParams(window.location.search).get('remote') === 'true');

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBEx2cWIr5e1vZamz65kq8cO1JQ0cUAzuQ",
  authDomain: "karaoke-control.firebaseapp.com",
  databaseURL: "https://karaoke-control-default-rtdb.firebaseio.com",
  projectId: "karaoke-control",
  storageBucket: "karaoke-control.firebasestorage.app",
  messagingSenderId: "868744728649",
  appId: "1:868744728649:web:500e5bec0ce4ca70f62f98"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// YouTube API key
const API_KEY = "AIzaSyDRqyB5XtgdHTtDVbhuIR5cL6OqDTZlFgE";

let playlist = [];
let currentIndex = 0;
let playerWindow = null;

// === SEND COMMAND ===
function sendCmd(action) {
  console.log("📤 Mengirim ke Firebase:", action);
  db.ref("commands").set({
    action: action,
    ts: Date.now()
  }).then(() => {
    console.log("✅ Terkirim ke Firebase:", action);
  }).catch(err => console.error("❌ Gagal kirim:", err));
}

// === LISTEN COMMAND (DESKTOP ONLY) ===
if (!isRemote) {
  db.ref("commands").on("value", snapshot => {
    const cmd = snapshot.val();
    if (!cmd || !cmd.action) return;
    console.log("📥 Diterima dari remote:", cmd.action);

    switch (cmd.action) {
      case "play": playSelected(); break;
      case "pause": pauseVideo(); break;
      case "next": nextSong(); break;
      case "up": moveUpLocal(); break;
      case "down": moveDownLocal(); break;
      case "clear": clearPlaylistLocal(); break;
    }

    // reset agar siap menerima perintah berikut
    db.ref("commands").set({});
  });
}

// === QR GENERATOR ===
const CONTROL_URL = "https://supiyantoian-gif.github.io/index.html/?remote=true";
window.addEventListener("load", () => {
  if (!isRemote) {
    const qrBox = document.getElementById("qr-container");
    qrBox.style.display = "block";
    new QRCode(document.getElementById("qrcode"), {
      text: CONTROL_URL,
      width: 120,
      height: 120,
      colorDark: "#00ffcc",
      colorLight: "#111",
      correctLevel: QRCode.CorrectLevel.H
    });
  } else {
    document.getElementById("qr-container").style.display = "none";
  }
});

// === Player window (desktop) ===
function openPlayer() {
  if (isRemote) return;
  if (!playerWindow || playerWindow.closed) {
    playerWindow = window.open("", "playerWindow", "width=900,height=600");
    playerWindow.document.write(`
      <html><body style="margin:0;background:black;overflow:hidden;">
      <div id="player"></div>
      <script>
        let player;
        window.addEventListener('message', e=>{
          if(e.data.type==='play' && player) player.loadVideoById(e.data.id);
          if(e.data.type==='pause' && player) player.pauseVideo();
        });
        function onYouTubeIframeAPIReady(){
          player = new YT.Player('player',{width:'100%',height:'100%',videoId:'',playerVars:{autoplay:1,controls:0}});
        }
      <\/script>
      <script src="https://www.youtube.com/iframe_api"><\/script>
      </body></html>
    `);
  }
}

function playSelected(){
  if(isRemote){ sendCmd("play"); return; }
  if(!playlist.length) return;
  if(!playerWindow || playerWindow.closed) openPlayer();
  const s = playlist[currentIndex];
  setTimeout(()=> playerWindow.postMessage({type:"play", id:s.id},"*"), 700);
}
function pauseVideo(){ if(isRemote){ sendCmd("pause"); return; } playerWindow?.postMessage({type:"pause"},"*"); }
function nextSong(){ if(isRemote){ sendCmd("next"); return; } if(currentIndex<playlist.length-1){ currentIndex++; playSelected(); } }
function moveUpLocal(){ if(currentIndex>0){ [playlist[currentIndex-1],playlist[currentIndex]]=[playlist[currentIndex],playlist[currentIndex-1]]; currentIndex--; renderPlaylist(); } }
function moveDownLocal(){ if(currentIndex<playlist.length-1){ [playlist[currentIndex+1],playlist[currentIndex]]=[playlist[currentIndex],playlist[currentIndex+1]]; currentIndex++; renderPlaylist(); } }
function clearPlaylistLocal(){ playlist=[]; currentIndex=0; renderPlaylist(); }

// === Search YouTube ===
async function doSearch(){
  const q=document.getElementById("searchInput").value.trim();
  const el=document.getElementById("searchResults");
  if(!q){ el.innerHTML="<i>Masukkan kata kunci...</i>"; return; }
  el.innerHTML="<i>Mencari...</i>";
  const url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q+" karaoke")}&key=${API_KEY}`;
  const resp=await fetch(url); const data=await resp.json();
  el.innerHTML="";
  data.items.forEach(item=>{
    const div=document.createElement("div");
    div.className="song";
    div.innerHTML=`<img class="thumb" src="${item.snippet.thumbnails.medium.url}"><div><div class="title">${item.snippet.title}</div><div class="channel">${item.snippet.channelTitle}</div></div>`;
    div.onclick=()=>addToPlaylist(item);
    el.appendChild(div);
  });
}

function addToPlaylist(item){
  const data={id:item.id.videoId,title:item.snippet.title,channel:item.snippet.channelTitle,thumb:item.snippet.thumbnails.medium.url};
  if(isRemote){ sendCmd("add_"+data.id); return; }
  playlist.push(data); renderPlaylist();
}

function renderPlaylist(){
  const el=document.getElementById("playlist");
  el.innerHTML="";
  playlist.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="song";
    div.innerHTML=`<img class="thumb" src="${s.thumb}"><div><div class="title">${i+1}. ${s.title}</div><div class="channel">${s.channel}</div></div>`;
    div.onclick=()=>{ currentIndex=i; playSelected(); };
    el.appendChild(div);
  });
}

// === Bind events ===
document.getElementById("searchBtn").onclick=doSearch;
document.getElementById("openPlayerBtn").onclick=openPlayer;
document.getElementById("playBtn").onclick=playSelected;
document.getElementById("pauseBtn").onclick=pauseVideo;
document.getElementById("nextBtn").onclick=nextSong;
document.getElementById("moveUpBtn").onclick=()=>moveUpLocal();
document.getElementById("moveDownBtn").onclick=()=>moveDownLocal();
document.getElementById("clearBtn").onclick=()=>clearPlaylistLocal();
</script>
</body>
</html>
