<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THE LINKS. KTV BATAM — Final (Mirror UI + Realtime)</title>
<style>
  *{box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  :root{
    --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
    --accent:#1db954; --accent-hover:#1ed760; --panel:rgba(255,255,255,0.04);
    --muted:#cfcfcf;
  }
  html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:#fff;}
  body{overflow-x:auto;} /* allow horizontal scroll so two-column remains identical on small screens */
  header{padding:12px 18px;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:space-between;}
  #searchBar{display:flex;gap:10px;align-items:center;}
  input{padding:10px;border:none;border-radius:6px;width:320px;background:rgba(255,255,255,0.02);color:#fff;}
  input::placeholder{color:rgba(255,255,255,0.6);}
  button{background:var(--accent);border:none;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all .12s;font-weight:700;}
  button:hover{background:var(--accent-hover);}
  #container{display:flex;gap:12px;height:calc(100vh - 170px);padding:12px;align-items:stretch;}
  #leftPanel, #rightPanel{flex:0 0 50%;min-width:420px;display:flex;flex-direction:column;gap:12px;height:100%;}
  #searchResults,#playlist{overflow:auto;padding:12px;background:var(--panel);border-radius:10px;height:100%;}
  .song{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.02);margin-bottom:8px;padding:8px;border-radius:8px;cursor:pointer;}
  .song:hover{background:rgba(255,255,255,0.06);}
  img.thumb{width:84px;border-radius:6px;flex-shrink:0;}
  .title{font-weight:800;font-size:14px;}
  .channel{font-size:12px;color:var(--muted);margin-top:4px;}
  #controls{display:flex;gap:8px;justify-content:center;padding:10px;background:rgba(0,0,0,0.35);position:fixed;left:50%;transform:translateX(-50%);bottom:12px;border-radius:10px;z-index:999;}
  #virtualKeyboard{display:none;grid-template-columns:repeat(10,1fr);gap:6px;padding:10px;background:rgba(0,0,0,0.55);position:fixed;left:50%;transform:translateX(-50%);bottom:72px;border-radius:10px;z-index:998;}
  #virtualKeyboard button{background:#222;border:1px solid #444;color:#FFD700;font-weight:700;padding:6px;border-radius:8px;}
  #navButtons{display:flex;gap:6px;}
  #qr-container{position:fixed;bottom:12px;right:12px;background:#0b0b0b;padding:10px;border-radius:10px;text-align:center;z-index:9999;box-shadow:0 8px 26px rgba(0,0,0,0.6);}
  #qr-container p{color:#fff;font-size:12px;margin:6px 0 0;}
  .small-ctrl{display:flex;gap:6px;margin-left:auto;}
  .small-ctrl button{padding:4px 6px;border-radius:6px;background:#222;border:none;color:#fff;cursor:pointer}
  @media (max-width:420px){ /* we intentionally keep identical UI; user can scroll horizontally */ }
</style>
</head>
<body>
<header>
  <div><strong>THE LINKS. KTV BATAM</strong></div>
  <div id="searchBar">
    <input id="searchInput" type="text" placeholder="Cari lagu..." autocomplete="off" />
    <button id="searchBtn">Cari</button>
    <div id="navButtons">
      <button id="upBtn">▲</button>
      <button id="downBtn">▼</button>
    </div>
    <button id="openPlayerBtn">Buka Layar 2</button>
  </div>
</header>

<div id="container">
  <div id="leftPanel">
    <div id="searchResults" aria-label="Hasil Pencarian">Ketik kata kunci lalu tekan Cari</div>
  </div>
  <div id="rightPanel">
    <div id="playlist" aria-label="Playlist">Playlist kosong</div>
  </div>
</div>

<div id="controls">
  <button id="playBtn">PLAY</button>
  <button id="pauseBtn">PAUSE</button>
  <button id="nextBtn">NEXT</button>
  <button id="moveUpBtn">UP</button>
  <button id="moveDownBtn">DOWN</button>
  <!-- CLEAR intentionally removed -->
</div>

<div id="virtualKeyboard" role="application" aria-hidden="true"></div>

<div id="qr-container" style="display:none;">
  <div id="qrcode"></div>
  <p>Scan untuk kontrol dari HP</p>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ========== CONFIG ========= */
const CLIENT_ID = `${Date.now()}_${Math.round(Math.random()*100000)}`;
const isRemote = (new URLSearchParams(window.location.search).get('remote') === 'true');
const CONTROL_URL = 'https://supiyantoian-gif.github.io/index.html/?remote=true';

const firebaseConfig = {
  apiKey: "AIzaSyBEx2cWIr5e1vZamz65kq8cO1JQ0cUAzuQ",
  authDomain: "karaoke-control.firebaseapp.com",
  databaseURL: "https://karaoke-control-default-rtdb.firebaseio.com",
  projectId: "karaoke-control",
  storageBucket: "karaoke-control.firebasestorage.app",
  messagingSenderId: "868744728649",
  appId: "1:868744728649:web:500e5bec0ce4ca70f62f98",
  measurementId: "G-PZMY40C4QX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const API_KEY = "AIzaSyBymqWa4Rx9Hk2efStErXI4c_1oqXkCf7s";

/* ========== STATE ========= */
let playlist = [];
let playlistMap = {};
let currentIndex = 0;
let playerWindow = null;
let selectedSearchIndex = -1;
let hasAutoPlayed = false;

/* ========== HELPERS ========= */
function showNotif(text){
  let n=document.getElementById('_notif_box_');
  if(!n){ n=document.createElement('div'); n.id='_notif_box_';
    Object.assign(n.style,{position:'fixed',bottom:'14px',left:'14px',background:'rgba(0,0,0,0.6)',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:99999});
    document.body.appendChild(n);
  }
  n.textContent=text; n.style.display='block'; clearTimeout(n._t); n._t=setTimeout(()=> n.style.display='none',1600);
}

/* ========== DB REFS ========= */
const playlistRef = db.ref('playlist');
const searchRef = db.ref('searchRequests');
const commandsRef = db.ref('commands');
const currentSongRef = db.ref('currentSong'); // <- current song sync

/* ========== SYNC: playlist, search, commands ========= */
/* playlist sync */
playlistRef.off();
playlistRef.on('child_added', snap=>{
  const key = snap.key; const v = snap.val();
  if(!v) return;
  if(playlistMap[key]) return;
  const item = { key, id:v.id, title:v.title, channel:v.channel, thumb:v.thumb||'', order:v.order||0 };
  playlistMap[key]=item; playlist.push(item); sortPlaylistAndRender();
});
playlistRef.on('child_changed', snap=>{
  const key=snap.key; const v=snap.val(); if(!v||!playlistMap[key]) return;
  playlistMap[key].id = v.id; playlistMap[key].title = v.title; playlistMap[key].channel = v.channel; playlistMap[key].thumb = v.thumb||'';
  playlistMap[key].order = v.order || playlistMap[key].order; sortPlaylistAndRender();
});
playlistRef.on('child_removed', snap=>{
  const key=snap.key; if(!playlistMap[key]) return;
  playlist = playlist.filter(p=>p.key!==key); delete playlistMap[key]; sortPlaylistAndRender();
});

function sortPlaylistAndRender(){
  // ascending: earliest (first chosen) at top, newest at bottom
  playlist.sort((a,b)=> (a.order||0) - (b.order||0));
  renderPlaylist();
}
function pushSongToPlaylist(payload){
  const node = {...payload, order: Date.now(), clientId: CLIENT_ID};
  return playlistRef.push(node).catch(e=>console.error('push song fail',e));
}

/* search sync */
searchRef.off();
searchRef.on('child_added', snap=>{
  const v = snap.val(); if(!v) return; if(v.clientId === CLIENT_ID) return;
  if(v.q) remoteDoSearch(v.q);
});
function broadcastSearch(q){ return searchRef.push({ q, ts: Date.now(), clientId: CLIENT_ID }).catch(e=>console.error('broadcastSearch fail',e)); }

/* commands */
commandsRef.off();

/* ========== YOUTUBE SEARCH (local & remote) ========= */
async function doSearch(){
  const q = (document.getElementById('searchInput') || {}).value?.trim() || '';
  const resultsEl = document.getElementById('searchResults');
  if(!q){ resultsEl.innerHTML = '<i>Masukkan kata kunci...</i>'; return; }
  resultsEl.innerHTML = '<i>Mencari...</i>';
  await broadcastSearch(q);

  const searchQuery = q.toLowerCase().includes('karaoke') ? q : q + ' karaoke';
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(searchQuery)}&key=${API_KEY}`;
  try{
    const resp = await fetch(url);
    const data = await resp.json();
    resultsEl.innerHTML = ''; selectedSearchIndex = -1;
    (data.items||[]).forEach(it=>{
      const thumb = it.snippet?.thumbnails?.medium?.url || '';
      const div = document.createElement('div'); div.className='song';
      div.onclick = ()=> localAddToPlaylist(it);
      div.innerHTML = `<img class="thumb" src="${thumb}"><div style="flex:1"><div class="title">${it.snippet.title}</div><div class="channel">${it.snippet.channelTitle}</div></div>`;
      resultsEl.appendChild(div);
    });
  }catch(e){ console.error(e); resultsEl.innerHTML = '<i>Gagal konek ke YouTube API</i>'; }
}

async function remoteDoSearch(q){
  const resultsEl = document.getElementById('searchResults');
  resultsEl.innerHTML = `<i>Mencari (remote): ${q}</i>`;
  const searchQuery = q.toLowerCase().includes('karaoke') ? q : q + ' karaoke';
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(searchQuery)}&key=${API_KEY}`;
  try{
    const resp = await fetch(url);
    const data = await resp.json();
    resultsEl.innerHTML = ''; selectedSearchIndex = -1;
    (data.items||[]).forEach(it=>{
      const thumb = it.snippet?.thumbnails?.medium?.url || '';
      const div = document.createElement('div'); div.className='song';
      div.onclick = ()=> localAddToPlaylist(it);
      div.innerHTML = `<img class="thumb" src="${thumb}"><div style="flex:1"><div class="title">${it.snippet.title}</div><div class="channel">${it.snippet.channelTitle}</div></div>`;
      resultsEl.appendChild(div);
    });
  }catch(e){ console.error(e); resultsEl.innerHTML = '<i>Gagal konek ke YouTube API</i>'; }
}

/* ========== ADD TO PLAYLIST ========== */
function localAddToPlaylist(item){
  let payload = null;
  if(item && item.id && item.id.videoId){
    payload = { id: item.id.videoId, title: item.snippet.title, channel: item.snippet.channelTitle, thumb: item.snippet?.thumbnails?.medium?.url || '' };
  } else if(item && item.id){
    payload = item;
  } else return;
  pushSongToPlaylist(payload).then(()=> showNotif('Added to playlist (synced)')).catch(e=>console.error(e));
}

/* ========== RENDER PLAYLIST (with highlight) ========= */
function renderPlaylist(){
  const el = document.getElementById('playlist'); if(!el) return; el.innerHTML = '';
  playlist.forEach((s,i)=>{
    const div = document.createElement('div'); div.className='song';
    // highlight if this is currentIndex
    if(i === currentIndex){
      div.style.background = 'rgba(0,255,128,0.20)';
      div.style.border = '1px solid rgba(0,255,128,0.45)';
    }
    div.innerHTML = `<img class="thumb" src="${s.thumb||''}"><div style="flex:1"><div class="title">${i+1}. ${s.title}</div><div class="channel">${s.channel}</div></div>`;
    div.onclick = ()=> { currentIndex = i; if(!isRemote) playSelected(); };

    // small control buttons
    const ctrl = document.createElement('div'); ctrl.className='small-ctrl';
    const up = document.createElement('button'); up.textContent='↑'; up.onclick = (ev)=>{ ev.stopPropagation(); moveUpDB(i); };
    const down = document.createElement('button'); down.textContent='↓'; down.onclick = (ev)=>{ ev.stopPropagation(); moveDownDB(i); };
    const del = document.createElement('button'); del.textContent='✕'; del.onclick = (ev)=>{ ev.stopPropagation(); removeFromDB(s.key); };
    [up,down,del].forEach(b=>Object.assign(b.style,{padding:'4px',borderRadius:'6px',background:'#222',color:'#fff'}));
    ctrl.appendChild(up); ctrl.appendChild(down); ctrl.appendChild(del);
    div.appendChild(ctrl);
    el.appendChild(div);
  });

  // keep top visible if current is top
  try{
    if(currentIndex === 0) el.scrollTop = 0;
  }catch(e){}
}

/* ========== DB reorder/remove/clear ========== */
function swapOrdersInDB(keyA,keyB){
  const a = playlistMap[keyA], b = playlistMap[keyB]; if(!a||!b) return;
  const updates = {}; updates[`${keyA}/order`] = b.order || 0; updates[`${keyB}/order`] = a.order || 0;
  return playlistRef.update(updates).catch(e=>console.error(e));
}
function moveUpDB(index){ if(index<=0) return; const item=playlist[index], prev=playlist[index-1]; if(item && prev) swapOrdersInDB(item.key, prev.key); }
function moveDownDB(index){ if(index>=playlist.length-1) return; const item=playlist[index], next=playlist[index+1]; if(item && next) swapOrdersInDB(item.key, next.key); }
function removeFromDB(key){ return playlistRef.child(key).remove().catch(e=>console.error(e)); }

/* ========== REMOVE CURRENT SONG FROM DB & PLAY NEXT (used for ended and Next button) ========== */
function removeCurrentFirstAndPlayNext(){
  if(!playlist || playlist.length === 0) return;

  // current first (position #1)
  const currentFirst = playlist[0];
  const nextItem = playlist[1] || null; // may be undefined
  if(!currentFirst) return;

  const keyToRemove = currentFirst.key;
  // remove first
  playlistRef.child(keyToRemove).remove().then(()=>{
    // clear currentSongRef
    currentSongRef.remove().catch(()=>{});
    // if there is a next item, set it to currentSongRef and play it
    if(nextItem){
      // small delay to let listeners update playlist array
      setTimeout(()=>{
        try{
          currentSongRef.set({ key: nextItem.key, title: nextItem.title || '', ts: Date.now() }).catch(()=>{});
          currentIndex = 0;
          if(isRemote) sendCommand('play');
          else {
            if(!playerWindow || playerWindow.closed) openPlayer();
            // directly post message to player
            try{ playerWindow.postMessage({ type: 'play', id: nextItem.id }, '*'); }catch(e){ console.error(e); playSelected(); }
          }
        }catch(err){ console.error('play next after remove error', err); }
      }, 300);
    } else {
      // nothing left after removal
      currentIndex = 0;
      renderPlaylist();
    }
  }).catch(err=>{
    console.error('Failed removing current first', err);
  });
}

/* ========== OPEN PLAYER (desktop only, player posts 'ended' on finish) ========== */
function openPlayer(){
  if(isRemote) return;
  if(!playerWindow || playerWindow.closed){
    playerWindow = window.open('','playerWindow','width=900,height=600');
    playerWindow.document.write(
      '<!doctype html><html><head><meta charset="utf-8"><title>Player</title></head><body style="margin:0;background:black;overflow:hidden;"><div id="player"></div>' +
      '<script>let player;function onPlayerStateChange(e){try{if(e.data===YT.PlayerState.ENDED){window.opener.postMessage({type:\"ended\"},\"*\");}}catch(e){} }' +
      'window.addEventListener("message",function(e){try{if(e.data&&e.data.type===\"play\"&&player)player.loadVideoById(e.data.id);if(e.data&&e.data.type===\"pause\"&&player)player.pauseVideo();}catch(err){}});' +
      'function onYouTubeIframeAPIReady(){player=new YT.Player("player",{width:"100%",height:"100%",videoId:"",playerVars:{autoplay:1,controls:0},events:{onReady:function(){try{window.opener.postMessage({type:\"autoPlay\"},\"*\");}catch(e){}},onStateChange:onPlayerStateChange}});}<\/script>' +
      '<script src="https://www.youtube.com/iframe_api"><\/script></body></html>'
    );
  } else {
    try{ if(playerWindow && !playerWindow.closed) playerWindow.postMessage({type:"autoPlay"},"*"); }catch(e){}
  }
}

/* ========== COMMANDS (send & listen) ========== */
function sendCommand(action,payload=null){ return commandsRef.push({ action, payload, ts: Date.now(), clientId: CLIENT_ID }).catch(e=>console.error(e)); }
commandsRef.off();
if(!isRemote){
  commandsRef.on('child_added', snapshot=>{
    const cmd = snapshot.val(); const key = snapshot.key;
    if(!cmd || !cmd.action){ if(key) snapshot.ref.remove(); return; }
    switch(cmd.action){
      case 'play': if(!playerWindow||playerWindow.closed) openPlayer(); setTimeout(()=>playSelected(),300); break;
      case 'pause': pauseVideo(); break;
      case 'next': removeCurrentFirstAndPlayNext(); break;
      case 'up': moveUpLocal(); break;
      case 'down': moveDownLocal(); break;
      case 'clear': /* intentionally ignored */ break;
      case 'add': if(cmd.payload && cmd.payload.id) pushSongToPlaylist(cmd.payload); break;
      default: console.log('Unknown cmd',cmd);
    }
    if(key) snapshot.ref.remove().catch(()=>{});
  });
}

/* local wrappers */
function playSelected(){
  if(isRemote){ sendCommand('play'); return; }
  if(!playlist.length) return;
  if(!playerWindow || playerWindow.closed) openPlayer();
  const s = playlist[currentIndex];
  setTimeout(()=>{
    try{
      playerWindow.postMessage({type:'play', id: s.id}, '*');
      // sync current song to Firebase so remotes highlight it
      if(s && s.key) currentSongRef.set({ key: s.key, title: s.title || '', ts: Date.now() }).catch(()=>{});
    }catch(e){ console.error(e); }
  },700);
}
function pauseVideo(){ if(isRemote){ sendCommand('pause'); return; } try{ playerWindow?.postMessage({type:'pause'},'*'); }catch(e){} }
function nextSong(){ 
  if(isRemote){ sendCommand('next'); return; } 
  // New behavior: remove current #1 and make #2 the new #1 and play it
  removeCurrentFirstAndPlayNext();
}
function moveUpLocal(){ if(isRemote){ sendCommand('up'); return; } if(currentIndex>0){ const item=playlist[currentIndex], prev=playlist[currentIndex-1]; if(item && prev) swapOrdersInDB(item.key, prev.key); } }
function moveDownLocal(){ if(isRemote){ sendCommand('down'); return; } if(currentIndex<playlist.length-1){ const item=playlist[currentIndex], next=playlist[currentIndex+1]; if(item && next) swapOrdersInDB(item.key, next.key); } }
function clearPlaylistLocal(){ if(isRemote){ sendCommand('clear'); return; } /* removed intentionally */ }

/* ========== AutoPlayOnce handling from playerWindow ========== */
window.addEventListener('message', function(e){
  if(e.data && e.data.type === 'autoPlay' && !hasAutoPlayed){
    if(playlist.length > 0){
      currentIndex = 0; playSelected(); hasAutoPlayed = true;
    }
  } else if(e.data && e.data.type === 'ended'){
    // when the player reports that video ended, remove current first and auto-play next
    removeCurrentFirstAndPlayNext();
  }
});

/* ========== currentSongRef listener: sync highlight across clients ========== */
currentSongRef.off();
currentSongRef.on('value', snap=>{
  const data = snap.val();
  if(!data) {
    renderPlaylist();
    return;
  }
  const idx = playlist.findIndex(p => p.key === data.key);
  if(idx >= 0){
    currentIndex = idx;
    renderPlaylist();
    const el = document.getElementById('playlist'); if(el) el.scrollTop = 0;
  }
});

/* ========== NAV HELPERS ========== */
function highlightSearchResult(){ const items=document.querySelectorAll('#searchResults .song'); items.forEach((div,i)=> div.style.background = i===selectedSearchIndex ? 'rgba(29,185,84,0.25)' : 'rgba(255,255,255,0.03)'); }
function moveSearchUp(){ const items=document.querySelectorAll('#searchResults .song'); if(items.length===0) return; selectedSearchIndex = selectedSearchIndex<=0 ? items.length-1 : selectedSearchIndex-1; highlightSearchResult(); }
function moveSearchDown(){ const items=document.querySelectorAll('#searchResults .song'); if(items.length===0) return; selectedSearchIndex = selectedSearchIndex>=items.length-1 ? 0 : selectedSearchIndex+1; highlightSearchResult(); }
function addSelectedSearchToPlaylist(){ const items=document.querySelectorAll('#searchResults .song'); if(selectedSearchIndex>=0 && selectedSearchIndex<items.length) items[selectedSearchIndex].click(); }

/* ========== VIRTUAL KEYBOARD ========== */
function createVirtualKeyboard(){ const vk=document.getElementById('virtualKeyboard'); if(!vk) return; vk.innerHTML=''; const keys=['Q','W','E','R','T','Y','U','I','O','P','A','S','D','F','G','H','J','K','L','Z','X','C','V','B','N','M','←','⏎','␣']; keys.forEach(k=>{ const b=document.createElement('button'); b.textContent=k; b.onclick=()=>virtualKeyPress(k); vk.appendChild(b); }); }
function virtualKeyPress(k){ const input=document.getElementById('searchInput'); if(!input) return; if(k==='←') input.value=input.value.slice(0,-1); else if(k==='⏎') doSearch(); else if(k==='␣') input.value+=' '; else input.value+=k; }

/* ========== BINDINGS (after DOM ready) ========== */
window.addEventListener('DOMContentLoaded', ()=>{

  // safe element getters
  const get = id => document.getElementById(id);

  // Bind UI controls (guarded)
  const btnSearch = get('searchBtn'); if(btnSearch) btnSearch.addEventListener('click', doSearch);
  const btnOpenPlayer = get('openPlayerBtn'); if(btnOpenPlayer) btnOpenPlayer.addEventListener('click', openPlayer);
  const btnPlay = get('playBtn'); if(btnPlay) btnPlay.addEventListener('click', playSelected);
  const btnPause = get('pauseBtn'); if(btnPause) btnPause.addEventListener('click', pauseVideo);
  const btnNext = get('nextBtn'); if(btnNext) btnNext.addEventListener('click', nextSong);
  const btnMoveUp = get('moveUpBtn'); if(btnMoveUp) btnMoveUp.addEventListener('click', ()=>{ if(isRemote) sendCommand('up'); else moveUpLocal(); });
  const btnMoveDown = get('moveDownBtn'); if(btnMoveDown) btnMoveDown.addEventListener('click', ()=>{ if(isRemote) sendCommand('down'); else moveDownLocal(); });
  const upBtn = get('upBtn'); if(upBtn) upBtn.addEventListener('click', moveSearchUp);
  const downBtn = get('downBtn'); if(downBtn) downBtn.addEventListener('click', moveSearchDown);

  // remove CLEAR button if present (safety)
  const clearBtn = get('clearBtn'); if(clearBtn) clearBtn.remove();

  createVirtualKeyboard();
  const sInput = get('searchInput');
  const vkEl = get('virtualKeyboard');
  if(sInput){
    sInput.addEventListener('focus', ()=> { if(vkEl) vkEl.style.display='grid'; });
    sInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
  }
  document.addEventListener('click', e=>{ if(vkEl && !vkEl.contains(e.target) && e.target !== sInput) vkEl.style.display='none'; });

  // hide open player button for remote clients but keep UI identical
  if(isRemote){
    try{ const op = get('openPlayerBtn'); if(op) op.style.display='none'; }catch(e){}
    showNotif('REMOTE MODE — kontrol desktop dari sini');
  }

  // QR generation (desktop only)
  try{
    if(!isRemote){
      const qrBox = get('qr-container'); if(qrBox) qrBox.style.display='block';
      new QRCode(get('qrcode'), { text: CONTROL_URL, width:140, height:140, colorDark:'#00ffcc', colorLight:'#111', correctLevel: QRCode.CorrectLevel.H });
    } else {
      const qrBox = get('qr-container'); if(qrBox) qrBox.style.display='none';
    }
  }catch(e){ console.error('QR error', e); }

  // load initial playlist once
  playlistRef.once('value').then(snap=>{
    const v = snap.val() || {};
    playlist = Object.keys(v).map(k=>({ key:k, id:v[k].id, title:v[k].title, channel:v[k].channel, thumb:v[k].thumb||'', order:v[k].order||0 }));
    playlist.forEach(p=> playlistMap[p.key]=p);
    sortPlaylistAndRender();
  }).catch(e=>console.error(e));
}); // DOMContentLoaded end

</script>
</body>
</html>

