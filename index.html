<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title> THE LINKS. KTV BATAM - Modern Dark (Thumbnail + UpDown + AutoPlay)</title>
<style>
  *{box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{margin:0;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;overflow:hidden;}
  header{padding:10px 20px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:space-between;}
  #searchBar{display:flex;gap:10px;align-items:center;}
  input{padding:10px;border:none;border-radius:5px;width:300px;}
  button{background:#1db954;border:none;color:#fff;padding:10px 15px;border-radius:5px;cursor:pointer;transition:0.2s;}
  button:hover{background:#1ed760;}
  #container{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 130px);}
  #searchResults,#playlist{overflow-y:auto;padding:15px;background:rgba(255,255,255,0.05);}
  .song{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.05);margin-bottom:8px;padding:8px;border-radius:6px;cursor:pointer;transition:0.2s;}
  .song:hover{background:rgba(255,255,255,0.15);}
  img.thumb{width:80px;border-radius:4px;}
  .title{font-weight:bold;font-size:14px;}
  .channel{font-size:12px;color:#ccc;}
  #controls{display:flex;gap:10px;justify-content:center;padding:10px;background:rgba(0,0,0,0.3);}
  #virtualKeyboard{display:none;grid-template-columns:repeat(10,1fr);gap:5px;padding:10px;background:rgba(0,0,0,0.3);position:absolute;bottom:10px;left:50%;transform:translateX(-50%);border-radius:10px;}
  #virtualKeyboard button{background:#333;border:1px solid #444;color:#FFD700;font-weight:bold;}
  #navButtons{display:flex;gap:5px;}
  /* QR di pojok kanan bawah persis seperti aslinya */
  #qr-container {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background:#111;
    padding:10px;
    border-radius:10px;
    text-align:center;
    z-index:9999;
  }
  #qr-container p{color:#fff;font-size:12px;margin:6px 0 0;}
  /* small responsive tweaks */
  @media (max-width:600px){
    input{width:160px;}
    img.thumb{width:64px;}
  }
</style>
</head>
<body>

<header>
  <div><strong>THE LINKS. KTV BATAM</strong></div>
  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Cari lagu..." />
    <button id="searchBtn">Cari</button>
    <div id="navButtons">
      <button id="upBtn">‚ñ≤</button>
      <button id="downBtn">‚ñº</button>
    </div>
    <button id="openPlayerBtn">Buka Layar 2</button>
  </div>
</header>

<div id="container">
  <div id="searchResults"></div>
  <div id="playlist"></div>
</div>

<div id="controls">
  <button id="playBtn">PLAY</button>
  <button id="pauseBtn">PAUSE</button>
  <button id="nextBtn">NEXT</button>
  <button id="moveUpBtn">UP</button>
  <button id="moveDownBtn">DOWN</button>
  <button id="clearBtn">CLEAR</button>
</div>

<div id="virtualKeyboard"></div>

<!-- QR container: TIDAK DIPINDAHKAN, tetap bottom-right -->
<div id="qr-container" style="display:none;">
  <div id="qrcode"></div>
  <p>Scan untuk kontrol dari HP</p>
</div>

<!-- Firebase v8 compat + QR lib -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ============================
   CONFIG / DETECTION
   ============================ */
const isRemote = (new URLSearchParams(window.location.search).get('remote') === 'true');

// Firebase config (pakai databaseURL)
const firebaseConfig = {
  apiKey: "AIzaSyBEx2cWIr5e1vZamz65kq8cO1JQ0cUAzuQ",
  authDomain: "karaoke-control.firebaseapp.com",
  databaseURL: "https://karaoke-control-default-rtdb.firebaseio.com",
  projectId: "karaoke-control",
  storageBucket: "karaoke-control.firebasestorage.app",
  messagingSenderId: "868744728649",
  appId: "1:868744728649:web:500e5bec0ce4ca70f62f98",
  measurementId: "G-PZMY40C4QX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================
   YouTube API key / app state
   ============================ */
const API_KEY = "AIzaSyDRqyB5XtgdHTtDVbhuIR5cL6OqDTZlFgE";
let playlist = [];
let currentIndex = 0;
let playerWindow = null;
let selectedSearchIndex = -1;

/* ============================
   Helper: send command from remote
   ============================ */
function sendCmd(action, payload = null){
  // Use a unique timestamp to reduce race issues
  db.ref('commands').set({ action, payload, ts: Date.now() })
    .catch(err => console.error('Gagal kirim perintah:', err));
}

/* ============================
   QR generation (desktop only)
   ============================ */
const CONTROL_URL = 'https://supiyantoian-gif.github.io/index.html/?remote=true';
window.addEventListener('load', ()=> {
  if (!isRemote) {
    // show qr at bottom-right
    const qrBox = document.getElementById('qr-container');
    qrBox.style.display = 'block';
    try {
      new QRCode(document.getElementById("qrcode"), {
        text: CONTROL_URL,
        width: 120,
        height: 120,
        colorDark : "#00ffcc",
        colorLight : "#111",
        correctLevel : QRCode.CorrectLevel.H
      });
    } catch(e){
      console.error('QR gen error', e);
    }
console.log("üî• Desktop listening to Firebase...");
db.ref('commands').on('value', (snapshot) => {
   // desktop listens to firebase commands
    db.ref('commands').on('value', (snapshot) => {
      const cmd = snapshot.val();
      if (!cmd || !cmd.action) return;
      console.log('Perintah diterima desktop:', cmd);

      // handle actions
      switch(cmd.action){
        case 'play':
          playSelected(); break;
        case 'pause':
          pauseVideo(); break;
        case 'next':
          nextSong(); break;
        case 'up':
          // when remote asked to move selected search up (or move playlist up)
          // here we try to emulate the existing moveUp behavior (on playlist)
          if(currentIndex>0){ moveUpLocal(); showNotif('Moved up'); }
          break;
        case 'down':
          if(currentIndex < playlist.length-1){ moveDownLocal(); showNotif('Moved down'); }
          break;
        case 'clear':
          clearPlaylistLocal(); break;
        case 'add':
          // payload expected: { id, title, channel, thumb }
          if(cmd.payload && cmd.payload.id){
            // add to desktop playlist
            playlist.push({
              id: cmd.payload.id,
              title: cmd.payload.title || 'Unknown',
              channel: cmd.payload.channel || '',
              thumb: cmd.payload.thumb || ''
            });
            renderPlaylist();
            showNotif('Added from remote');
            // if empty before, auto play
            if(playlist.length === 1){ currentIndex = 0; playSelected(); }
          }
          break;
        default:
          console.log('Unknown action', cmd.action);
      }

      // remove command after processing
      db.ref('commands').remove().catch(()=>{});
    });
  } else {
    // remote mode: hide qr container
    document.getElementById('qr-container').style.display = 'none';
  }
});

/* ============================
   Small visual notification on desktop
   ============================ */
function showNotif(text){
  let n = document.getElementById('_notif_box_');
  if(!n){
    n = document.createElement('div');
    n.id = '_notif_box_';
    n.style.position = 'fixed';
    n.style.bottom = '10px';
    n.style.left = '10px';
    n.style.background = 'rgba(0,0,0,0.6)';
    n.style.color = '#fff';
    n.style.padding = '8px 12px';
    n.style.borderRadius = '8px';
    n.style.zIndex = 99999;
    document.body.appendChild(n);
  }
  n.textContent = text;
  n.style.display = 'block';
  clearTimeout(n._t);
  n._t = setTimeout(()=> n.style.display='none', 1800);
}

/* ============================
   Virtual Keyboard
   ============================ */
function createVirtualKeyboard(){
  const vk = document.getElementById("virtualKeyboard");
  vk.innerHTML = '';
  const keys = ['Q','W','E','R','T','Y','U','I','O','P',
                'A','S','D','F','G','H','J','K','L',
                'Z','X','C','V','B','N','M','‚Üê','‚èé','‚ê£'];
  keys.forEach(k=>{
    const btn = document.createElement('button');
    btn.textContent = k;
    btn.onclick = ()=> virtualKeyPress(k);
    vk.appendChild(btn);
  });
}
function virtualKeyPress(k){
  const input = document.getElementById('searchInput');
  if(!input) return;
  if(k==='‚Üê') input.value = input.value.slice(0,-1);
  else if(k==='‚èé') doSearch();
  else if(k==='‚ê£') input.value += ' ';
  else input.value += k;
}

/* ============================
   YouTube Search + Playlist (works both desktop & remote)
   - If on remote, adding a song sends an 'add' command to desktop
   - If on desktop, adding a song modifies local playlist
   ============================ */
async function doSearch(){
  const q = document.getElementById('searchInput').value.trim();
  const resultsEl = document.getElementById('searchResults');
  if(!q){ resultsEl.innerHTML = '<i>Masukkan kata kunci...</i>'; return; }
  resultsEl.innerHTML = '<i>Mencari...</i>';
  const searchQuery = q.toLowerCase().includes('karaoke') ? q : q + ' karaoke';
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(searchQuery)}&key=${API_KEY}`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if(!data.items){ resultsEl.innerHTML = '<i>Gagal mengambil hasil.</i>'; return; }
    resultsEl.innerHTML = '';
    selectedSearchIndex = -1;
    data.items.forEach((item,i)=>{
      const div = document.createElement('div');
      div.className = 'song';
      div.onclick = ()=> addToPlaylist(item);
      div.innerHTML = `
        <img class="thumb" src="${item.snippet.thumbnails?.medium?.url || ''}">
        <div><div class="title">${item.snippet.title}</div>
        <div class="channel">${item.snippet.channelTitle}</div></div>`;
      resultsEl.appendChild(div);
    });
  } catch(e){
    console.error(e);
    resultsEl.innerHTML = '<i>Gagal konek ke YouTube API</i>';
  }
}

/* Add song - behavior differs by mode:
   - Desktop: add locally
   - Remote: send add command to desktop with payload
*/
function addToPlaylist(itemOrData){
  // itemOrData might be API item (with id.videoId) or direct payload
  let payload;
  if(itemOrData && itemOrData.id && itemOrData.id.videoId){
    payload = {
      id: itemOrData.id.videoId,
      title: itemOrData.snippet?.title || '',
      channel: itemOrData.snippet?.channelTitle || '',
      thumb: itemOrData.snippet?.thumbnails?.medium?.url || ''
    };
  } else if (itemOrData && itemOrData.id) {
    payload = itemOrData;
  } else return;

  if(isRemote){
    // send add request to desktop
    sendCmd('add', payload);
    showNotif('Mengirim lagu ke desktop...');
    return;
  }

  // desktop: add locally
  playlist.push({
    id: payload.id,
    title: payload.title,
    channel: payload.channel,
    thumb: payload.thumb
  });
  renderPlaylist();
  if(playlist.length === 1){
    currentIndex = 0;
    playSelected();
  }
}

function renderPlaylist(){
  const el = document.getElementById('playlist');
  el.innerHTML = '';
  playlist.forEach((song, i)=>{
    const div = document.createElement('div');
    div.className = 'song';
    div.innerHTML = `
      <img class="thumb" src="${song.thumb}">
      <div>
        <div class="title">${i+1}. ${song.title}</div>
        <div class="channel">${song.channel}</div>
      </div>`;
    div.onclick = ()=> { currentIndex = i; if(!isRemote) playSelected(); };
    el.appendChild(div);
  });
}

/* Local moveUp / moveDown that do not send to Firebase (desktop-only helpers) */
function moveUpLocal(){
  if(currentIndex>0){
    [playlist[currentIndex-1], playlist[currentIndex]] = [playlist[currentIndex], playlist[currentIndex-1]];
    currentIndex--;
    renderPlaylist();
  }
}
function moveDownLocal(){
  if(currentIndex < playlist.length-1){
    [playlist[currentIndex+1], playlist[currentIndex]] = [playlist[currentIndex], playlist[currentIndex+1]];
    currentIndex++;
    renderPlaylist();
  }
}
function clearPlaylistLocal(){
  playlist = [];
  currentIndex = 0;
  renderPlaylist();
}

/* ============================
   Player window logic (desktop only)
   ============================ */
function openPlayer(){
  if(isRemote) return; // remote tidak membuka player
  if(!playerWindow || playerWindow.closed){
    playerWindow = window.open("", "playerWindow", "width=900,height=600");
    playerWindow.document.write(`
      <html><body style="margin:0;background:black;overflow:hidden;"><div id="player"></div>
      <script>
        let player;
        window.addEventListener('message', e=>{
          try {
            if(e.data.type === 'play' && player) player.loadVideoById(e.data.id);
            if(e.data.type === 'pause' && player) player.pauseVideo();
          } catch(err){}
        });
        function onYouTubeIframeAPIReady(){
          player = new YT.Player('player',{width:'100%',height:'100%',videoId:'',playerVars:{autoplay:1,controls:0}});
        }
      <\/script>
      <script src="https://www.youtube.com/iframe_api"><\/script>
      </body></html>
    `);
  }
}

function playSelected(){
  if(isRemote){
    sendCmd('play');
    return;
  }
  if(!playlist.length) return;
  if(!playerWindow || playerWindow.closed) openPlayer();
  const s = playlist[currentIndex];
  setTimeout(()=> {
    try { playerWindow.postMessage({ type: 'play', id: s.id }, '*'); }
    catch(e){ console.error(e); }
  }, 700);
}
function pauseVideo(){
  if(isRemote){
    sendCmd('pause');
    return;
  }
  try { playerWindow?.postMessage({ type: 'pause' }, '*'); } catch(e){}
}
function nextSong(){
  if(isRemote){
    sendCmd('next');
    return;
  }
  if(currentIndex < playlist.length - 1){
    currentIndex++;
    playSelected();
  }
}
function moveUp(){
  if(isRemote){
    sendCmd('up');
    return;
  }
  moveUpLocal();
}
function moveDown(){
  if(isRemote){
    sendCmd('down');
    return;
  }
  moveDownLocal();
}
function clearPlaylist(){
  if(isRemote){
    sendCmd('clear');
    return;
  }
  clearPlaylistLocal();
}

/* message listener from child player window: auto-play when ready */
window.addEventListener('message', e=>{
  if(e.data === 'ready'){
    const s = playlist[currentIndex];
    try { playerWindow.postMessage({ type: 'play', id: s.id }, '*'); } catch(e){}
  }
});

/* ============================
   Bind UI events
   ============================ */
document.getElementById('searchBtn').onclick = doSearch;
document.getElementById('openPlayerBtn').onclick = openPlayer;
document.getElementById('playBtn').onclick = playSelected;
document.getElementById('pauseBtn').onclick = pauseVideo;
document.getElementById('nextBtn').onclick = nextSong;
document.getElementById('moveUpBtn').onclick = moveUp;
document.getElementById('moveDownBtn').onclick = moveDown;
document.getElementById('clearBtn').onclick = clearPlaylist;
document.getElementById('upBtn').onclick = moveSearchUp;
document.getElementById('downBtn').onclick = moveSearchDown;

/* helper for search highlight */
function highlightSearchResult(){
  const items = document.querySelectorAll('#searchResults .song');
  items.forEach((div,i)=> div.style.background = i===selectedSearchIndex ? 'rgba(29,185,84,0.4)' : 'rgba(255,255,255,0.05)');
}
function moveSearchUp(){
  const items=document.querySelectorAll('#searchResults .song');
  if(items.length===0) return;
  selectedSearchIndex = selectedSearchIndex<=0 ? items.length-1 : selectedSearchIndex-1;
  highlightSearchResult();
}
function moveSearchDown(){
  const items=document.querySelectorAll('#searchResults .song');
  if(items.length===0) return;
  selectedSearchIndex = selectedSearchIndex>=items.length-1 ? 0 : selectedSearchIndex+1;
  highlightSearchResult();
}
function addSelectedSearchToPlaylist(){
  const items=document.querySelectorAll('#searchResults .song');
  if(selectedSearchIndex>=0 && selectedSearchIndex<items.length) items[selectedSearchIndex].click();
}

/* ============================
   Remote mode adjustments:
   - hide openPlayerBtn
   - ensure control buttons send commands (already handled in functions)
   - when remote adds a song, send command 'add' (handled)
   ============================ */
if(isRemote){
  // hide Buka Layar 2 to avoid confusion on phone
  try { document.getElementById('openPlayerBtn').style.display = 'none'; } catch(e){}
  // show notification that we are in remote
  showNotif('REMOTE MODE ‚Äî kontrol desktop dari sini');

  // optionally we could style/scale some elements for mobile, but keep layout identical per request
}

/* ============================
   Init keyboard / UI
   ============================ */
createVirtualKeyboard();
const searchInput = document.getElementById('searchInput');
const vk = document.getElementById('virtualKeyboard');
searchInput.addEventListener('focus', ()=> vk.style.display = 'grid');
document.addEventListener('click', e => { if(!vk.contains(e.target) && e.target !== searchInput) vk.style.display = 'none'; });

</script>
</body>
</html>

