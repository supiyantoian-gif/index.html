<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Karaoke Operator - THE LINKS KTV</title>
<style>
body{background:#000;color:#fff;font-family:sans-serif;text-align:center;margin:0;padding:0;}
#player{width:80%;height:60vh;margin:auto;margin-top:30px;border:3px solid #1db954;border-radius:10px;}
#current{margin-top:20px;font-size:20px;}
#playlist{max-width:700px;margin:20px auto;text-align:left;}
.song{background:#111;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
#qrPanel{position:fixed;right:20px;bottom:20px;background:rgba(255,255,255,0.1);padding:10px;border-radius:10px;text-align:center;}
#qrcode{background:#fff;padding:8px;border-radius:8px;display:inline-block;}
#qrTitle{font-size:14px;margin-bottom:5px;color:#FFD700;}
button{background:#1db954;border:none;color:#fff;padding:8px 12px;border-radius:5px;cursor:pointer;margin-top:10px;}
button:hover{background:#1ed760;}
</style>
</head>
<body>
<h2>üé§ THE LINKS KTV - Operator</h2>
<div id="player"></div>
<div id="current">Menunggu lagu...</div>

<h3>üéµ Playlist Lagu</h3>
<div id="playlist"></div>
<button onclick="clearPlaylist()">üóëÔ∏è Kosongkan Playlist</button>

<!-- Panel QR Remote -->
<div id="qrPanel">
  <div id="qrTitle">üì± Scan untuk buka Remote</div>
  <div id="qrcode"></div>
</div>

<!-- Firebase + YouTube + QR -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// === Firebase Config ===
const firebaseConfig = {
  apiKey: "AIzaSyBnW5cUpoHzUpdN0UuVR5q8D7Epzuh46MY",
  authDomain: "karaoke-remote.firebaseapp.com",
  projectId: "karaoke-remote",
  storageBucket: "karaoke-remote.firebasestorage.app",
  messagingSenderId: "780368521995",
  appId: "1:780368521995:web:9175227e4529393d8f900e",
  measurementId: "G-6BFKKTY4CK",
  databaseURL: "https://karaoke-remote-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let player;
let currentSong = null;

// === YouTube Player ===
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    height: '390',
    width: '640',
    videoId: '',
    playerVars: { 'autoplay': 1, 'controls': 1 },
    events: {
      'onReady': () => console.log("Player siap"),
      'onStateChange': onPlayerStateChange
    }
  });
}

// === Saat lagu selesai otomatis lanjut ===
function onPlayerStateChange(e){
  if(e.data === YT.PlayerState.ENDED){
    nextSong();
  }
}

// === Render playlist ===
function renderPlaylist(list){
  const p = document.getElementById("playlist");
  p.innerHTML = "";
  list.forEach((s, i)=>{
    const div = document.createElement("div");
    div.className = "song";
    div.innerHTML = `<div>${i+1}. ${s.title}</div><button onclick="removeSong(${i})">‚ùå</button>`;
    p.appendChild(div);
  });
}

// === Ambil playlist realtime ===
db.ref("karaoke/playlist").on("value", snap=>{
  const list = snap.val() || [];
  renderPlaylist(list);
  if(!currentSong && list.length > 0){
    playSong(list[0]);
  }
});

// === Kontrol dari Remote ===
db.ref("karaoke/control").on("value", snap=>{
  const c = snap.val();
  if(!c) return;
  if(c.action === "play" && player) player.playVideo();
  if(c.action === "pause" && player) player.pauseVideo();
  if(c.action === "next") nextSong();
});

// === Play lagu ===
function playSong(song){
  if(!song) return;
  currentSong = song;
  document.getElementById("current").textContent = "üéµ " + song.title;
  player.loadVideoById(song.id);
  db.ref("karaoke/current").set(song);
}

// === Hapus lagu ===
function removeSong(index){
  db.ref("karaoke/playlist").once("value").then(snap=>{
    const list = snap.val() || [];
    list.splice(index,1);
    db.ref("karaoke/playlist").set(list);
  });
}

// === Lagu berikutnya ===
function nextSong(){
  db.ref("karaoke/playlist").once("value").then(snap=>{
    const list = snap.val() || [];
    if(list.length > 1){
      list.shift();
      db.ref("karaoke/playlist").set(list);
      playSong(list[0]);
    } else {
      db.ref("karaoke/playlist").set([]);
      document.getElementById("current").textContent = "Menunggu lagu...";
      currentSong = null;
    }
  });
}

// === Kosongkan playlist ===
function clearPlaylist(){
  db.ref("karaoke/playlist").set([]);
  document.getElementById("playlist").innerHTML = "";
  document.getElementById("current").textContent = "Menunggu lagu...";
  currentSong = null;
}

// === QR Code (otomatis link ke remote.html) ===
const remoteURL = window.location.origin + "/remote.html";
new QRCode(document.getElementById("qrcode"), {
  text: remoteURL,
  width: 150,
  height: 150,
  colorDark : "#000000",
  colorLight : "#ffffff",
  correctLevel : QRCode.CorrectLevel.H
});
</script>
</body>
</html>
