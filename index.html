<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE LINKS. KTV BATAM - Remote Control Ready</title>
<style>
  *{box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{margin:0;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;overflow:hidden;position:relative;}
  header{padding:10px 20px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:space-between;}
  #searchBar{display:flex;gap:10px;align-items:center;}
  input{padding:10px;border:none;border-radius:5px;width:300px;}
  button{background:#1db954;border:none;color:#fff;padding:10px 15px;border-radius:5px;cursor:pointer;transition:0.2s;}
  button:hover{background:#1ed760;}
  #container{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 130px);}
  #searchResults,#playlist{overflow-y:auto;padding:15px;background:rgba(255,255,255,0.05);}
  .song{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.05);margin-bottom:8px;padding:8px;border-radius:6px;cursor:pointer;transition:0.2s;}
  .song:hover{background:rgba(255,255,255,0.15);}
  img.thumb{width:80px;border-radius:4px;}
  .title{font-weight:bold;font-size:14px;}
  .channel{font-size:12px;color:#ccc;}
  #controls{display:flex;gap:10px;justify-content:center;padding:10px;background:rgba(0,0,0,0.3);}
  #virtualKeyboard{display:none;grid-template-columns:repeat(10,1fr);gap:5px;padding:10px;background:rgba(0,0,0,0.3);position:absolute;bottom:10px;left:50%;transform:translateX(-50%);border-radius:10px;}
  #virtualKeyboard button{background:#333;border:1px solid #444;color:#FFD700;font-weight:bold;}
  #navButtons{display:flex;gap:5px;}
  #qrBox{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.5);padding:10px;border-radius:10px;}
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
<header>
  <div><strong>THE LINKS. KTV BATAM</strong></div>
  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Cari lagu..." />
    <button id="searchBtn">Cari</button>
    <div id="navButtons">
      <button id="upBtn">‚ñ≤</button>
      <button id="downBtn">‚ñº</button>
    </div>
    <button id="openPlayerBtn">Buka Layar 2</button>
  </div>
</header>

<div id="container">
  <div id="searchResults"></div>
  <div id="playlist"></div>
</div>

<div id="controls">
  <button onclick="playSelected()">PLAY</button>
  <button onclick="pauseVideo()">PAUSE</button>
  <button onclick="nextSong()">NEXT</button>
  <button onclick="moveUp()">UP</button>
  <button onclick="moveDown()">DOWN</button>
  <button onclick="clearPlaylist()">CLEAR</button>
</div>

<div id="virtualKeyboard"></div>
<div id="qrBox"><div id="qrcode"></div></div>

<script>
/* === Firebase Config === */
const firebaseConfig = {
  apiKey: "AIzaSyBEx2cWIr5e1vZamz65kq8cO1JQ0cUAzuQ",
  authDomain: "karaoke-control.firebaseapp.com",
  projectId: "karaoke-control",
  storageBucket: "karaoke-control.firebasestorage.app",
  messagingSenderId: "868744728649",
  appId: "1:868744728649:web:500e5bec0ce4ca70f62f98",
  measurementId: "G-PZMY40C4QX",
  databaseURL: "https://karaoke-control-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === QR Code untuk Remote === */
const controlUrl = "https://supiyantoian-gif.github.io/index.html/?remote=true";
new QRCode(document.getElementById("qrcode"), {
  text: controlUrl,
  width: 120,
  height: 120,
  colorDark: "#ffffff",
  colorLight: "transparent"
});

/* === Deteksi mode remote === */
const isRemote = window.location.search.includes("remote=true");
if(isRemote){
  document.body.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
      <h2>REMOTE CONTROL</h2>
      <button onclick="sendCmd('play')">‚ñ∂Ô∏è PLAY</button>
      <button onclick="sendCmd('pause')">‚è∏ PAUSE</button>
      <button onclick="sendCmd('next')">‚è≠ NEXT</button>
      <button onclick="sendCmd('up')">üîº UP</button>
      <button onclick="sendCmd('down')">üîΩ DOWN</button>
      <button onclick="sendCmd('clear')">üóë CLEAR</button>
    </div>`;
  document.querySelectorAll('button').forEach(b=>{
    b.style.margin='10px';b.style.padding='15px 30px';b.style.fontSize='18px';
    b.style.borderRadius='10px';b.style.border='none';b.style.background='#1db954';b.style.color='white';
  });
  window.sendCmd = (cmd)=>firebase.database().ref("commands").set({cmd, time:Date.now()});
}

/* === Aplikasi utama === */
const API_KEY = "AIzaSyDRqyB5XtgdHTtDVbhuIR5cL6OqDTZlFgE";
let playlist=[],currentIndex=0,playerWindow=null,selectedSearchIndex=-1;

function createVirtualKeyboard(){
  const vk=document.getElementById("virtualKeyboard");
  const keys='QWERTYUIOPASDFGHJKLZXCVBNM‚Üê‚èé‚ê£'.split('');
  keys.forEach(k=>{
    const b=document.createElement('button');
    b.textContent=k;b.onclick=()=>virtualKeyPress(k);vk.appendChild(b);
  });
}
function virtualKeyPress(k){
  const input=document.getElementById('searchInput');
  if(k==='‚Üê') input.value=input.value.slice(0,-1);
  else if(k==='‚èé') doSearch();
  else if(k==='‚ê£') input.value+=' ';
  else input.value+=k;
}
async function doSearch(){
  const q=document.getElementById('searchInput').value.trim();
  const resEl=document.getElementById('searchResults');
  if(!q){resEl.innerHTML='<i>Masukkan kata kunci...</i>';return;}
  resEl.innerHTML='<i>Mencari...</i>';
  const searchQuery=q.toLowerCase().includes('karaoke')?q:q+' karaoke';
  const url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(searchQuery)}&key=${API_KEY}`;
  const data=await (await fetch(url)).json();
  resEl.innerHTML='';
  data.items.forEach((item)=>{
    const div=document.createElement('div');
    div.className='song';
    div.onclick=()=>addToPlaylist(item);
    div.innerHTML=`<img class="thumb" src="${item.snippet.thumbnails.medium.url}">
      <div><div class="title">${item.snippet.title}</div>
      <div class="channel">${item.snippet.channelTitle}</div></div>`;
    resEl.appendChild(div);
  });
}
function addToPlaylist(item){
  playlist.push({id:item.id.videoId,title:item.snippet.title,channel:item.snippet.channelTitle,thumb:item.snippet.thumbnails.medium.url});
  renderPlaylist();
  if(playlist.length===1){currentIndex=0;playSelected();}
}
function renderPlaylist(){
  const el=document.getElementById('playlist');
  el.innerHTML='';
  playlist.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='song';
    div.innerHTML=`<img class="thumb" src="${s.thumb}"><div><div class="title">${i+1}. ${s.title}</div><div class="channel">${s.channel}</div></div>`;
    div.onclick=()=>{currentIndex=i;playSelected();};
    el.appendChild(div);
  });
}
function moveUp(){if(currentIndex>0){[playlist[currentIndex-1],playlist[currentIndex]]=[playlist[currentIndex],playlist[currentIndex-1]];currentIndex--;renderPlaylist();}}
function moveDown(){if(currentIndex<playlist.length-1){[playlist[currentIndex+1],playlist[currentIndex]]=[playlist[currentIndex],playlist[currentIndex+1]];currentIndex++;renderPlaylist();}}
function openPlayer(){
  if(!playerWindow||playerWindow.closed){
    playerWindow=window.open("","playerWindow","width=800,height=600");
    playerWindow.document.write(`<html><body style="margin:0;background:black;"><div id='player'></div>
    <script>
    let player;window.addEventListener('message',e=>{if(e.data.type==='play'&&player){player.loadVideoById(e.data.id);}if(e.data.type==='pause'&&player){player.pauseVideo();}});
    function onYouTubeIframeAPIReady(){player=new YT.Player('player',{width:'100%',height:'100%',videoId:'',playerVars:{autoplay:1,controls:0},events:{onReady:()=>window.opener.postMessage('ready','*')}});}
    <\/script><script src='https://www.youtube.com/iframe_api'><\/script></body></html>`);
  }
}
function playSelected(){if(!playlist.length)return;if(!playerWindow||playerWindow.closed)openPlayer();const s=playlist[currentIndex];setTimeout(()=>playerWindow.postMessage({type:'play',id:s.id},'*'),1000);}
function nextSong(){if(currentIndex<playlist.length-1){currentIndex++;playSelected();}}
function pauseVideo(){playerWindow?.postMessage({type:'pause'},'*');}
function clearPlaylist(){playlist=[];renderPlaylist();}
window.addEventListener('message',e=>{if(e.data==='ready'){const s=playlist[currentIndex];playerWindow.postMessage({type:'play',id:s.id},'*');}});
document.getElementById('searchBtn').onclick=doSearch;
document.getElementById('openPlayerBtn').onclick=openPlayer;
document.getElementById('upBtn').onclick=()=>firebase.database().ref("commands").set({cmd:"up",time:Date.now()});
document.getElementById('downBtn').onclick=()=>firebase.database().ref("commands").set({cmd:"down",time:Date.now()});
createVirtualKeyboard();
const searchInput=document.getElementById('searchInput');
const vk=document.getElementById('virtualKeyboard');
searchInput.addEventListener('focus',()=>vk.style.display='grid');
document.addEventListener('click',e=>{if(!vk.contains(e.target)&&e.target!==searchInput)vk.style.display='none';});

/* === Listener Firebase Command === */
firebase.database().ref("commands").on("value",snap=>{
  const v=snap.val();if(!v)return;
  switch(v.cmd){
    case 'play': playSelected();break;
    case 'pause': pauseVideo();break;
    case 'next': nextSong();break;
    case 'up': moveUp();break;
    case 'down': moveDown();break;
    case 'clear': clearPlaylist();break;
  }
});
</script>
</body>
</html>
