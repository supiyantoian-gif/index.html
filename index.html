<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THE LINKS. KTV BATAM - AutoPlayOnce Remote Fixed</title>
<style>
  *{box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{margin:0;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;overflow:hidden;}
  header{padding:10px 20px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:space-between;}
  #searchBar{display:flex;gap:10px;align-items:center;}
  input{padding:10px;border:none;border-radius:5px;width:300px;}
  button{background:#1db954;border:none;color:#fff;padding:10px 15px;border-radius:5px;cursor:pointer;transition:0.2s;}
  button:hover{background:#1ed760;}
  #container{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 130px);}
  #searchResults,#playlist{overflow-y:auto;padding:15px;background:rgba(255,255,255,0.05);}
  .song{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.05);margin-bottom:8px;padding:8px;border-radius:6px;cursor:pointer;transition:0.2s;}
  .song:hover{background:rgba(255,255,255,0.15);}
  img.thumb{width:80px;border-radius:4px;}
  .title{font-weight:bold;font-size:14px;}
  .channel{font-size:12px;color:#ccc;}
  #controls{display:flex;gap:10px;justify-content:center;padding:10px;background:rgba(0,0,0,0.3);}
  #virtualKeyboard{display:none;grid-template-columns:repeat(10,1fr);gap:5px;padding:10px;background:rgba(0,0,0,0.3);position:absolute;bottom:10px;left:50%;transform:translateX(-50%);border-radius:10px;}
  #virtualKeyboard button{background:#333;border:1px solid #444;color:#FFD700;font-weight:bold;}
  #navButtons{display:flex;gap:5px;}
  #qr-container{position:fixed;bottom:10px;right:10px;background:#111;padding:10px;border-radius:10px;text-align:center;z-index:9999;}
  #qr-container p{color:#fff;font-size:12px;margin:6px 0 0;}
  @media (max-width:600px){ input{width:160px;} img.thumb{width:64px;} }
</style>
</head>
<body>
<header>
  <div><strong>THE LINKS. KTV BATAM</strong></div>
  <div id="searchBar">
    <input id="searchInput" type="text" placeholder="Cari lagu..." />
    <button id="searchBtn">Cari</button>
    <div id="navButtons">
      <button id="upBtn">▲</button>
      <button id="downBtn">▼</button>
    </div>
    <button id="openPlayerBtn">Buka Layar 2</button>
  </div>
</header>
<div id="container">
  <div id="searchResults"></div>
  <div id="playlist"></div>
</div>
<div id="controls">
  <button id="playBtn">PLAY</button>
  <button id="pauseBtn">PAUSE</button>
  <button id="nextBtn">NEXT</button>
  <button id="moveUpBtn">UP</button>
  <button id="moveDownBtn">DOWN</button>
  <button id="clearBtn">CLEAR</button>
</div>
<div id="virtualKeyboard"></div>
<div id="qr-container" style="display:none;">
  <div id="qrcode"></div>
  <p>Scan untuk kontrol dari HP</p>
</div>

<!-- Firebase + QR -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const isRemote = (new URLSearchParams(window.location.search).get('remote') === 'true');
const firebaseConfig = {
  apiKey: "AIzaSyBEx2cWIr5e1vZamz65kq8cO1JQ0cUAzuQ",
  authDomain: "karaoke-control.firebaseapp.com",
  databaseURL: "https://karaoke-control-default-rtdb.firebaseio.com",
  projectId: "karaoke-control",
  storageBucket: "karaoke-control.firebasestorage.app",
  messagingSenderId: "868744728649",
  appId: "1:868744728649:web:500e5bec0ce4ca70f62f98",
  measurementId: "G-PZMY40C4QX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const API_KEY = "AIzaSyDRqyB5XtgdHTtDVbhuIR5cL6OqDTZlFgE";

let playlist=[], currentIndex=0, playerWindow=null, selectedSearchIndex=-1;
let hasAutoPlayed=false;

/* ---------- notification ---------- */
function showNotif(text){
  let n=document.getElementById('_notif_box_');
  if(!n){
    n=document.createElement('div');
    n.id='_notif_box_';
    n.style.position='fixed';n.style.bottom='10px';n.style.left='10px';
    n.style.background='rgba(0,0,0,0.6)';n.style.color='#fff';
    n.style.padding='8px 12px';n.style.borderRadius='8px';
    n.style.zIndex=99999;document.body.appendChild(n);
  }
  n.textContent=text;n.style.display='block';clearTimeout(n._t);
  n._t=setTimeout(()=>n.style.display='none',1600);
}

/* ---------- Firebase command listener ---------- */
function sendCmd(action,payload=null){
  db.ref('commands').push({action,payload,ts:Date.now()});
}
if(!isRemote){
  db.ref('commands').on('child_added',snap=>{
    const c=snap.val(),k=snap.key;
    if(!c||!c.action){if(k)snap.ref.remove();return;}
    switch(c.action){
      case'play':if(!playerWindow||playerWindow.closed)openPlayer();setTimeout(()=>playSelected(),300);break;
      case'pause':pauseVideo();break;
      case'next':nextSong();break;
      case'up':moveUpLocal();break;
      case'down':moveDownLocal();break;
      case'clear':clearPlaylistLocal();break;
      case'add':if(c.payload&&c.payload.id){playlist.push(c.payload);renderPlaylist();showNotif('Added from remote');if(playlist.length===1){currentIndex=0;setTimeout(()=>playSelected(),300);}}break;
    }
    if(k)snap.ref.remove();
  });
}

/* ---------- QR code ---------- */
const CONTROL_URL='https://supiyantoian-gif.github.io/index.html/?remote=true';
window.addEventListener('load',()=>{
  if(!isRemote){
    const qr=document.getElementById('qr-container');
    qr.style.display='block';
    new QRCode(document.getElementById('qrcode'),{text:CONTROL_URL,width:120,height:120,colorDark:'#00ffcc',colorLight:'#111',correctLevel:QRCode.CorrectLevel.H});
  }else{
    document.getElementById('qr-container').style.display='none';
    showNotif('REMOTE MODE — kontrol desktop dari sini');
  }
});

/* ---------- Virtual Keyboard ---------- */
function createVirtualKeyboard(){
  const vk=document.getElementById('virtualKeyboard');
  vk.innerHTML='';
  const keys='QWERTYUIOPASDFGHJKLZXCVBNM←⏎␣'.split('');
  keys.forEach(k=>{
    const b=document.createElement('button');
    b.textContent=k;b.onclick=()=>virtualKeyPress(k);
    vk.appendChild(b);
  });
}
function virtualKeyPress(k){
  const i=document.getElementById('searchInput');
  if(!i)return;
  if(k==='←')i.value=i.value.slice(0,-1);
  else if(k==='⏎')doSearch();
  else if(k==='␣')i.value+=' ';
  else i.value+=k;
}

/* ---------- YouTube search ---------- */
async function doSearch(){
  const q=document.getElementById('searchInput').value.trim();
  const r=document.getElementById('searchResults');
  if(!q){r.innerHTML='<i>Masukkan kata kunci...</i>';return;}
  r.innerHTML='<i>Mencari...</i>';
  const searchQuery=q.toLowerCase().includes('karaoke')?q:q+' karaoke';
  const url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(searchQuery)}&key=${API_KEY}`;
  try{
    const resp=await fetch(url);const data=await resp.json();r.innerHTML='';selectedSearchIndex=-1;
    (data.items||[]).forEach(it=>{
      const thumb=it.snippet?.thumbnails?.medium?.url||'';
      const div=document.createElement('div');
      div.className='song';div.onclick=()=>addToPlaylist(it);
      div.innerHTML=`<img class="thumb" src="${thumb}"><div><div class="title">${it.snippet.title}</div><div class="channel">${it.snippet.channelTitle}</div></div>`;
      r.appendChild(div);
    });
  }catch{r.innerHTML='<i>Gagal konek ke YouTube API</i>';}
}
function addToPlaylist(it){
  let p=null;
  if(it?.id?.videoId)p={id:it.id.videoId,title:it.snippet.title,channel:it.snippet.channelTitle,thumb:it.snippet.thumbnails.medium.url};
  else if(it?.id)p=it;else return;
  if(isRemote){sendCmd('add',p);showNotif('Mengirim lagu ke desktop...');return;}
  playlist.push(p);renderPlaylist();
  if(playlist.length===1){currentIndex=0;playSelected();}
}
function renderPlaylist(){
  const el=document.getElementById('playlist');el.innerHTML='';
  playlist.forEach((s,i)=>{
    const d=document.createElement('div');d.className='song';
    d.innerHTML=`<img class="thumb" src="${s.thumb||''}"><div><div class="title">${i+1}. ${s.title}</div><div class="channel">${s.channel}</div></div>`;
    d.onclick=()=>{currentIndex=i;if(!isRemote)playSelected();};
    el.appendChild(d);
  });
}

/* ---------- Player window ---------- */
function openPlayer(){
  if(isRemote)return;
  if(!playerWindow||playerWindow.closed){
    playerWindow=window.open('','playerWindow','width=900,height=600');
    playerWindow.document.write(
      '<!doctype html><html><head><meta charset=\"utf-8\"><title>Player</title></head>'+
      '<body style=\"margin:0;background:black;overflow:hidden;\"><div id=\"player\"></div>'+
      '<script>let player;window.addEventListener(\"message\",function(e){try{if(e.data&&e.data.type===\"play\"&&player)player.loadVideoById(e.data.id);if(e.data&&e.data.type===\"pause\"&&player)player.pauseVideo();}catch(err){}});function onYouTubeIframeAPIReady(){player=new YT.Player(\"player\",{width:\"100%\",height:\"100%\",videoId:\"\",playerVars:{autoplay:1,controls:0},events:{onReady:function(){try{window.opener.postMessage({type:\"autoPlay\"},\"*\");}catch(e){}}}});}<\/script>'+
      '<script src=\"https://www.youtube.com/iframe_api\"><\/script></body></html>'
    );
  }
}

/* ---------- AutoPlayOnce Listener ---------- */
window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='autoPlay'&&!hasAutoPlayed){
    if(playlist.length>0){
      playSelected();
      hasAutoPlayed=true; // hanya 1x per sesi
    }
  }
});

/* ---------- Controls ---------- */
function playSelected(){
  if(isRemote){sendCmd('play');return;}
  if(!playlist.length)return;
  if(!playerWindow||playerWindow.closed)openPlayer();
  const s=playlist[currentIndex];
  setTimeout(()=>{try{playerWindow.postMessage({type:'play',id:s.id},'*');}catch(e){}},700);
}
function pauseVideo(){if(isRemote){sendCmd('pause');return;}try{playerWindow?.postMessage({type:'pause'},'*');}catch{}}
function nextSong(){if(isRemote){sendCmd('next');return;}if(currentIndex<playlist.length-1){currentIndex++;playSelected();}}
function moveUpLocal(){if(currentIndex>0){[playlist[currentIndex-1],playlist[currentIndex]]=[playlist[currentIndex],playlist[currentIndex-1]];currentIndex--;renderPlaylist();}}
function moveDownLocal(){if(currentIndex<playlist.length-1){[playlist[currentIndex+1],playlist[currentIndex]]=[playlist[currentIndex],playlist[currentIndex+1]];currentIndex++;renderPlaylist();}}
function clearPlaylistLocal(){playlist=[];currentIndex=0;renderPlaylist();}

/* ---------- Bindings ---------- */
document.getElementById('searchBtn').onclick=doSearch;
document.getElementById('openPlayerBtn').onclick=openPlayer;
document.getElementById('playBtn').onclick=playSelected;
document.getElementById('pauseBtn').onclick=pauseVideo;
document.getElementById('nextBtn').onclick=nextSong;
document.getElementById('moveUpBtn').onclick=moveUpLocal;
document.getElementById('moveDownBtn').onclick=moveDownLocal;
document.getElementById('clearBtn').onclick=clearPlaylistLocal;

createVirtualKeyboard();
const input=document.getElementById('searchInput');
const vk=document.getElementById('virtualKeyboard');
input.addEventListener('focus',()=>vk.style.display='grid');
document.addEventListener('click',e=>{if(!vk.contains(e.target)&&e.target!==input)vk.style.display='none';});
if(isRemote){document.getElementById('openPlayerBtn').style.display='none';}
</script>
</body>
</html>
